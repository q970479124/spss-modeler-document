# 回归预测方法 #
## 一、 数据探索 ##
`模型看到是结果而不是原始值`  

### 1. 直方图 ###
> 直方图本质是展示连续数据分布规律的图表，X 轴代表数据的分组区间，Y 轴代表对应区间的数据频次。
<img width="1375" height="907" alt="image" src="https://github.com/user-attachments/assets/fe0779bd-c41c-4ba7-89be-433f914aed52" />

- X轴为数据分组，如房价在十万、二十万、三十万...的连续分组。
- Y轴为X轴分组范围内出现的频率范围。

> **说明：** 直方图主要能看出数据分布状态，比如正态分布、偏态分布
>   偏态分布又分为左偏态(负偏)和右偏态(正偏)
>   - 左偏态： 偏度值 <0，分布的 “长尾” 在左侧，均值 < 中位数 < 众数。
>   - 右偏态： 偏度值 > 0，分布的 “长尾” 在右侧，均值 > 中位数 > 众数。
>   - 对称分布： 偏度值 ≈ 0，均值 ≈ 中位数 ≈ 众数，如正态分布。

**树模型时直方图的作用**
| 目的                  | 为什么重要                                            |
| ------------------- | ------------------------------------------------ |
| 1️⃣ 检查异常值（Outliers） | 偏态可能掩盖极端点，树会错误地以异常值分裂                            |
| 2️⃣ 判断是否需要分箱或截断     | 如果极端长尾太长，模型学习效率会变差                               |
| 3️⃣ 数据理解            | 了解特征分布能帮助你解释模型输出与特征重要性                           |
| 4️⃣ 调参辅助            | 极端偏态时，`max_depth`、`min_child_weight`等参数的最佳值可能会变化 |
| 5️⃣ 提升可解释性          | 对数变换后，特征变化和结果关系更直观                               |

---

#### 处理偏态 ####
右偏态可以直接处理，左偏态需要转换成右偏态再处理（如果模型敏感或需要解释性，就需要转换回来）
模型看到是结果而不是原始值
**偏态处理流程**
| 步骤     | 操作                                 | 工具/方法                              |
| ------ | ---------------------------------- | ---------------------------------- |
| ① 判断   | 看直方图 + 箱线图 + 计算偏度                  | `sns.histplot`, `scipy.stats.skew` |
| ② 判断影响 | 判断目标/特征、模型类型                       | 表格决策                               |
| ③ 变换   | log / sqrt / Box-Cox / Yeo–Johnson | `np.log1p`, `PowerTransformer`     |
| ④ 验证   | 重新画图 + 比较偏度 + 比较模型RMSE             | `skew()`, `mean_squared_error`     |
| ⑤ 落地   | 在建模/预测中使用变换后的值                     | `exp()` 反变换预测值                     |

---

**偏度计算**
>  - 皮尔逊偏度系数（Pearson Skewness）
>  - 公式为：\(Sk_1 = \frac{3(\bar{x} - Med)}{s}\)
>    - \(\bar{x}\)（样本均值）：所有数据的平均值，对极端值敏感，是偏度计算的 “核心参照”。
>    - Med（样本中位数）：将数据从小到大排序后，位于中间位置的数值，对极端值不敏感，是衡量分布 “中心位置” 的稳定指标。
>    - s（样本标准差）：衡量数据整体离散程度的指标，在这里作为 “标准化因子”，让偏度系数不受数据单位影响（比如身高用厘米或米，偏度结果一致）。
>    - 系数 “3”：是经验系数，通过大量数据验证，用 3 倍的 “均值 - 中位数” 差值除以标准差，能让偏度结果更贴合实际分布的偏斜感知。

|      | 偏度绝对值   | 含义   | 处理建议     |
| ---- | ------- | ---- | -------- |
| 轻微偏态 | < 0.5   | 近似对称 | 可不处理     |
| 中度偏态 | 0.5～1.0 | 偏态明显 | 考虑轻度变换   |
| 严重偏态 | > 1.0   | 强偏态  | 建议变换或标准化 |

---

**判断是否需要处理偏态**
| 情况                       | 是否需要处理              |       |        |
| ------------------------ | ------------------- | ----- | ------ |
| 目标变量用于线性回归、线性建模          | ✅ 需要（保持残差正态）        |       |        |
| 特征变量用于线性或距离模型            | ✅ 需要（保持尺度合理）        |       |        |
| 树模型（RF/XGBoost/LightGBM） | ❌ 可不处理              |       |        |
| 偏态不大（                    | skew                | <0.5） | ❌ 可不处理 |
| 数据带 0 或负值                | ⚠️ 不可直接取 log，需要特殊变换 |       |        |

---

**偏态处理方法**
| 方法                 | 适用条件      | Python 实现                                                      | 说明          |
| ------------------ | --------- | -------------------------------------------------------------- | ----------- |
| **log-transform**  | 数据>0 且右偏  | `np.log(y)` 或 `np.log1p(y)`                                    | 压缩右尾        |
| **平方根变换 (sqrt)**   | 数据≥0，轻度右偏 | `np.sqrt(y)`                                                   | 较温和         |
| **Box–Cox 变换**     | 数据>0      | `scipy.stats.boxcox(y)`                                        | 自动找最佳λ      |
| **Yeo–Johnson 变换** | 数据可含负值    | `sklearn.preprocessing.PowerTransformer(method='yeo-johnson')` | 广义适用        |
| **反转 + log**       | 左偏（负偏）    | `np.log(y.max()+1 - y)`                                        | 把左偏变右偏再 log |

---

**常用处理**
| 方法                        | 适用场景    | 说明         |
| ------------------------- | ------- | ---------- |
| 对数/Box–Cox/Yeo–Johnson 变换 | 特征为正且右偏 | 平滑分布、线性化   |
| 分箱（binning）或离散化           | 极度偏态或长尾 | 用分位数切分更稳健  |
| Winsorization（截尾）         | 有极端离群值  | 限制极端值对模型影响 |
| 标准化或归一化                   | 轻微偏态    | 缩放到统一范围    |

---

**进阶：偏态后的建模策略**
| 模型类型          | 偏态处理重点              | 备注          |
| ------------- | ------------------- | ----------- |
| 线性回归          | ✅ 对目标变量做 log        | 确保残差正态      |
| Lasso / Ridge | ✅ 对所有偏态特征做 log/sqrt | 提升收敛与解释性    |
| 树模型           | ⚙️ 可选               | 有时可只平滑极端值   |
| 时间序列 / 回归预测   | ✅ 对目标 log，预测后反变换    | 常用于预测销量、价格等 |
| 聚类 / PCA      | ✅ 对特征变换             | 减少方差主导效应    |

---

## 2. Q-Q图(分位图) ##
<img width="295" height="244" alt="image" src="https://github.com/user-attachments/assets/0ffe75b8-ee13-4dc1-8ab5-7297b162981b" />

<img width="314" height="243" alt="image" src="https://github.com/user-attachments/assets/611e1954-50bc-402d-bfcb-c3c1b13ecfe8" />

> Q-Q 图本质是通过对比数据的分位数与理论分布的分位数，来检验数据分布一致性的图形，x 轴代表理论分位数，y 轴代表实际数据分位数。
> X轴：理论分布的分位数，`根据 “正态分布” 算出的 “标准答案”`
> Y轴：实际数据的经验分位数，`收集的真实数据中排序后得到的 “实际值”`  

>Q-Q 图是“样本分布与理论分布”的分位数对比图。
>若点落在直线上 → 数据服从理论分布；
>若尾部偏离 → 说明存在偏态或重尾现象。
<img width="1048" height="294" alt="image" src="https://github.com/user-attachments/assets/2a88b35e-32bc-4a83-94f9-47c16e46e0cd" />

上图展示了三种典型 Q-Q 图：
- 左图（正态分布）：点几乎落在直线上 → 数据服从正态分布。
- 中图（右偏分布）：右上角的点向上翘 → 尾部更长 → 右偏。
- 右图（左偏分布）：左下角的点向下弯 → 左尾更长 → 左偏。
通过观察尾部是否偏离直线，就能快速判断数据偏态方向和是否接近正态，非常适合用于判断是否需要对数变换或其他数据标准化处理。

`单个弯或直线说明了数据属于偏态分布或理论分布，但是出现多个弯折时说明数据需要分组预测，每个弯服从的分布规律不一致。`

**尾处理**
| 现象               | 含义                         | 说明               |
| ---------------- | -------------------------- | ---------------- |
| **右上角点偏离直线、往上翘** | **右尾太厚**（heavy right tail） | 极大值太多 / 太大       |
| **右上角点往下弯**      | **右尾太轻**（light right tail） | 极大值太少 / 太集中      |
| **左下角点偏离直线、往下翘** | **左尾太厚**（heavy left tail）  | 极小值太多 / 太小       |
| **左下角点往上弯**      | **左尾太轻**（light left tail）  | 极小值太少 / 太集中      |
| **两端都翘**         | **双尾厚尾**（heavy tails）      | 比正态分布更极端（如 t 分布） |

**为什么要做“尾处理（Tail Treatment）**
> 因为 Q–Q 图的尾部偏离说明：
> 数据中存在极端值、异常值或非正态尾特征；
> 极端尾会显著影响模型学习；
> 特别是对 线性模型、统计检验、残差正态性假设 非常致命。
>
> 举例：
> 在回归模型中，如果右尾很厚（极大值多），
> 残差分布就会右偏 → 置信区间、p 值全失真。

`处理方式和直方图一致`

  
  
